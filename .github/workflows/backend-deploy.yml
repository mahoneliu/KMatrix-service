name: Deploy Backend & Docker

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 检出后端代码
      uses: actions/checkout@v4
      with:
        path: kmatrix-service

    - name: 配置 JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Maven 编译打包
      run: mvn clean package -DskipTests
      working-directory: ./kmatrix-service

    - name: 预清理旧的服务程序文件 (使用 sudo 防止权限问题)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        password: ${{ secrets.UBUNTU_PASSWORD }}
        port: ${{ secrets.UBUNTU_PORT || '22' }}
        script: |
          cd ${{ secrets.UBUNTU_TARGET_DIR }}
          # 强制清理被 root 用户创建的老旧文件，避免 SCP 传输时报 Cannot open (File exists)
          sudo rm -rf ruoyi-admin.jar lib/*

    - name: 准备目标服务器运行环境 (上传 Jar 文件)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        password: ${{ secrets.UBUNTU_PASSWORD }}
        port: ${{ secrets.UBUNTU_PORT || '22' }}
        source: "kmatrix-service/ruoyi-admin/target/ruoyi-admin.jar,kmatrix-service/ruoyi-admin/target/lib/*"
        target: "${{ secrets.UBUNTU_TARGET_DIR }}"
        # 剥离 kmatrix-service/ruoyi-admin/target 这一共 3 层结构
        strip_components: 3
        # 强制覆盖已有文件
        overwrite: true

    - name: SSH 连接到 Ubuntu 并执行重启命令
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        password: ${{ secrets.UBUNTU_PASSWORD }}
        port: ${{ secrets.UBUNTU_PORT || '22' }}
        script: |
          # 进入目标部署目录
          cd ${{ secrets.UBUNTU_TARGET_DIR }}
          
          echo "执行重启命令..."
          bash sudo start.sh restart
          
          echo "部署命令执行完毕！"

    - name: 检出前端代码
      uses: actions/checkout@v4
      with:
        repository: mahoneliu/Kmatrix-ui
        path: kmatrix-ui

    - name: 配置 Node 环境及 pnpm
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: 安装 pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9

    - name: 前端安装依赖并构建
      run: |
        pnpm install
        pnpm run build
      working-directory: ./kmatrix-ui

    - name: 登录阿里云 Docker Registry
      uses: docker/login-action@v3
      with:
        registry: registry.cn-guangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_DOCKER_USERNAME }}
        password: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}

    - name: 准备并构建最新的 Docker 镜像
      run: |
        # 生成基于 Git SHA 的唯一版本号标签
        COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        TARGET_IMAGE="registry.cn-guangzhou.aliyuncs.com/kyxxjs/kmatrix:$COMMIT_SHA"
        LATEST_IMAGE="registry.cn-guangzhou.aliyuncs.com/kyxxjs/kmatrix:latest"
        
        # 编译构建 standalone 镜像
        docker build -t $TARGET_IMAGE -t $LATEST_IMAGE -f kmatrix-service/docker/Dockerfile.standalone .
        
        # 推送镜像到阿里云
        docker push $TARGET_IMAGE
        docker push $LATEST_IMAGE
